#!/usr/bin/env bash
# NPM Restore Script
# Restores NPM data and certificates from a backup archive.

set -euo pipefail

# Usage function
usage() {
    echo "Usage: $0 <backup-archive-path>"
    echo ""
    echo "Example: $0 /var/backups/npm-20240101120000.tar.gz"
    exit 1
}

# Check arguments
if [[ $# -ne 1 ]]; then
    echo "Error: Backup archive path required"
    usage
fi

BACKUP_ARCHIVE="$1"

# Validate backup archive exists
if [[ ! -f "$BACKUP_ARCHIVE" ]]; then
    echo "Error: Backup archive not found: $BACKUP_ARCHIVE"
    usage
fi

# Validate it's a tar.gz file
if [[ ! "$BACKUP_ARCHIVE" =~ \.(tar\.gz|tgz)$ ]]; then
    echo "Error: Backup archive must be a .tar.gz or .tgz file"
    exit 1
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "NPM Restore Process"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Backup archive: $BACKUP_ARCHIVE"
echo ""

# Step 1: Stop NPM stack
echo "[1/7] Stopping NPM stack..."
if systemctl stop npm 2>&1; then
    echo "✓ NPM service stopped"
else
    EXIT_CODE=$?
    if systemctl is-active --quiet npm 2>/dev/null; then
        echo "✗ Error: Failed to stop NPM service (exit code: $EXIT_CODE)"
        exit 1
    else
        echo "⚠ NPM service was already stopped"
    fi
fi

# Give it a moment to fully stop
sleep 2

# Step 2: Create safety backup of existing data
echo ""
echo "[2/7] Creating safety backup of existing data..."

SAFETY_TIMESTAMP=$(date +%Y%m%d%H%M%S)
DATA_DIR="/opt/npm/data"
LETSENCRYPT_DIR="/opt/npm/letsencrypt"
DATA_BACKUP="/opt/npm/data.bak-${SAFETY_TIMESTAMP}"
LETSENCRYPT_BACKUP="/opt/npm/letsencrypt.bak-${SAFETY_TIMESTAMP}"

SAFETY_BACKUP_CREATED=false

# Backup data directory if it exists and is non-empty
if [[ -d "$DATA_DIR" ]] && [[ -n "$(ls -A "$DATA_DIR" 2>/dev/null)" ]]; then
    echo "  Moving $DATA_DIR to $DATA_BACKUP"
    mv "$DATA_DIR" "$DATA_BACKUP"
    SAFETY_BACKUP_CREATED=true
    echo "  ✓ Data directory backed up"
else
    echo "  ℹ Data directory does not exist or is empty, skipping backup"
fi

# Backup letsencrypt directory if it exists and is non-empty
if [[ -d "$LETSENCRYPT_DIR" ]] && [[ -n "$(ls -A "$LETSENCRYPT_DIR" 2>/dev/null)" ]]; then
    echo "  Moving $LETSENCRYPT_DIR to $LETSENCRYPT_BACKUP"
    mv "$LETSENCRYPT_DIR" "$LETSENCRYPT_BACKUP"
    SAFETY_BACKUP_CREATED=true
    echo "  ✓ Let's Encrypt directory backed up"
else
    echo "  ℹ Let's Encrypt directory does not exist or is empty, skipping backup"
fi

if [[ "$SAFETY_BACKUP_CREATED" == true ]]; then
    echo "✓ Safety backup created (timestamp: $SAFETY_TIMESTAMP)"
else
    echo "ℹ No existing data to backup"
fi

# Step 3: Validate archive contents (security check)
echo ""
echo "[3/7] Validating archive contents..."

# SECURITY: Only allow paths within expected NPM directories.
# This prevents malicious archives from overwriting system files like /etc/passwd.
# Allowed prefixes (with or without leading "./"):
#   opt/npm/data/...
#   opt/npm/letsencrypt/...

ALLOWED_PATTERN='^(\./)?(opt/npm/data(/|$)|opt/npm/letsencrypt(/|$))'

# List all entries in the archive and check each one
INVALID_PATHS=()
while IFS= read -r entry; do
    # Normalize: remove leading "./" for consistent matching
    normalized="${entry#./}"
    
    # Check if entry matches allowed pattern
    if [[ ! "$normalized" =~ $ALLOWED_PATTERN ]]; then
        INVALID_PATHS+=("$entry")
    fi
done < <(tar -tzf "$BACKUP_ARCHIVE" 2>/dev/null)

if [[ ${#INVALID_PATHS[@]} -gt 0 ]]; then
    echo "✗ Error: Archive contains paths outside allowed directories!"
    echo ""
    echo "Allowed paths: opt/npm/data/*, opt/npm/letsencrypt/*"
    echo ""
    echo "Invalid paths found (first 10):"
    for ((i=0; i<${#INVALID_PATHS[@]} && i<10; i++)); do
        echo "  - ${INVALID_PATHS[$i]}"
    done
    if [[ ${#INVALID_PATHS[@]} -gt 10 ]]; then
        echo "  ... and $((${#INVALID_PATHS[@]} - 10)) more"
    fi
    echo ""
    echo "This archive may be corrupted or malicious. Restore aborted."
    exit 1
fi

echo "✓ Archive contents validated (all paths within allowed directories)"

# Step 4: Extract the backup archive
echo ""
echo "[4/7] Extracting backup archive..."

# Extract from root (/) so absolute paths are restored correctly
# Use safer flags: --no-same-owner prevents ownership issues, --no-overwrite-dir is safer
cd /
if tar --extract --gzip --file "$BACKUP_ARCHIVE" --no-same-owner --no-overwrite-dir 2>&1; then
    echo "✓ Archive extracted successfully"
else
    EXIT_CODE=$?
    echo "✗ Error: Failed to extract archive (exit code: $EXIT_CODE)"
    exit 1
fi

# Verify extracted directories exist
if [[ ! -d "$DATA_DIR" ]]; then
    echo "✗ Error: Data directory not found after extraction: $DATA_DIR"
    exit 1
fi

if [[ ! -d "$LETSENCRYPT_DIR" ]]; then
    echo "⚠ Warning: Let's Encrypt directory not found after extraction: $LETSENCRYPT_DIR"
    echo "  This is normal if the backup was created before certificates were issued"
fi

# Step 5: Fix ownership and permissions
echo ""
echo "[5/7] Setting ownership and permissions..."

# Set ownership to root:root (v1 assumption)
if chown -R root:root "$DATA_DIR" 2>/dev/null; then
    echo "✓ Data directory ownership set"
else
    echo "⚠ Warning: Failed to set ownership on data directory"
fi

if [[ -d "$LETSENCRYPT_DIR" ]]; then
    if chown -R root:root "$LETSENCRYPT_DIR" 2>/dev/null; then
        echo "✓ Let's Encrypt directory ownership set"
    else
        echo "⚠ Warning: Failed to set ownership on Let's Encrypt directory"
    fi
fi

# Step 6: Start NPM stack
echo ""
echo "[6/7] Starting NPM stack..."

if systemctl start npm 2>&1; then
    echo "✓ NPM service started"
else
    EXIT_CODE=$?
    echo "✗ Error: Failed to start NPM service (exit code: $EXIT_CODE)"
    exit 1
fi

# Give it a moment to start
sleep 3

# Step 7: Basic health check
echo ""
echo "[7/7] Performing health check..."

MAX_WAIT=60
WAIT_INTERVAL=2
ELAPSED=0
HEALTH_CHECK_PASSED=false

echo "  Waiting for NPM to be ready (max ${MAX_WAIT}s)..."

while [[ $ELAPSED -lt $MAX_WAIT ]]; do
    # Check if port 81 responds with HTTP 200-399
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:81/api 2>/dev/null || echo "000")
    
    if [[ "$HTTP_CODE" =~ ^[23][0-9]{2}$ ]]; then
        HEALTH_CHECK_PASSED=true
        echo "  ✓ Health check passed (HTTP $HTTP_CODE)"
        break
    fi
    
    sleep $WAIT_INTERVAL
    ELAPSED=$((ELAPSED + WAIT_INTERVAL))
    echo "  ... waiting (${ELAPSED}s/${MAX_WAIT}s)"
done

if [[ "$HEALTH_CHECK_PASSED" == false ]]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "⚠ WARNING: Health check failed"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "NPM may not be responding correctly. Please check:"
    echo "  - Service status: systemctl status npm"
    echo "  - Container logs: docker compose logs (in /opt/npm)"
    echo "  - Port 81: curl http://localhost:81/api"
    echo ""
    
    if [[ "$SAFETY_BACKUP_CREATED" == true ]]; then
        echo "If you need to roll back, restore from the safety backup:"
        if [[ -d "$DATA_BACKUP" ]]; then
            echo "  Data: $DATA_BACKUP"
        fi
        if [[ -d "$LETSENCRYPT_BACKUP" ]]; then
            echo "  Let's Encrypt: $LETSENCRYPT_BACKUP"
        fi
        echo ""
        echo "To restore manually:"
        echo "  1. systemctl stop npm"
        echo "  2. rm -rf /opt/npm/data /opt/npm/letsencrypt"
        echo "  3. mv $DATA_BACKUP /opt/npm/data"
        if [[ -d "$LETSENCRYPT_BACKUP" ]]; then
            echo "  4. mv $LETSENCRYPT_BACKUP /opt/npm/letsencrypt"
        fi
        echo "  5. systemctl start npm"
    fi
    
    echo ""
    echo "Restore completed, but health check failed. Please investigate."
    exit 1
fi

# Success
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Restore completed successfully!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "NPM is running and responding. You can access the admin UI at:"
echo "  http://<instance-ip>:81"
echo ""

if [[ "$SAFETY_BACKUP_CREATED" == true ]]; then
    echo "Note: Safety backup created with timestamp: $SAFETY_TIMESTAMP"
    echo "  You can remove the .bak directories once you've verified everything works:"
    if [[ -d "$DATA_BACKUP" ]]; then
        echo "    rm -rf $DATA_BACKUP"
    fi
    if [[ -d "$LETSENCRYPT_BACKUP" ]]; then
        echo "    rm -rf $LETSENCRYPT_BACKUP"
    fi
    echo ""
fi

exit 0

