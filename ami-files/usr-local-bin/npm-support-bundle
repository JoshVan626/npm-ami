#!/usr/bin/env bash
# NPM Support Bundle Script
# Collects diagnostics for Nginx Proxy Manager – Hardened Edition (Ubuntu 22.04) by Northstar Cloud Solutions into a single tar.gz file.

set -euo pipefail

OUTPUT_BASE="/var/backups"
TIMESTAMP="$(date +%Y%m%d%H%M%S)"
BUNDLE_DIR="${OUTPUT_BASE}/npm-support-${TIMESTAMP}"
BUNDLE_ARCHIVE="${OUTPUT_BASE}/npm-support-${TIMESTAMP}.tar.gz"

mkdir -p "$BUNDLE_DIR"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Nginx Proxy Manager – Hardened Edition (Ubuntu 22.04) by Northstar Cloud Solutions - Support Bundle"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Creating support bundle directory: $BUNDLE_DIR"
echo ""

# 1) Basic system info
echo "[1/6] Collecting system information..."
{
    echo "=== uname -a ==="
    uname -a || true
    echo ""

    echo "=== lsb_release -a ==="
    lsb_release -a 2>/dev/null || true
    echo ""

    echo "=== uptime ==="
    uptime || true
    echo ""

    echo "=== df -h ==="
    df -h || true
    echo ""

    echo "=== free -h ==="
    free -h 2>/dev/null || true
    echo ""

} > "${BUNDLE_DIR}/system-info.txt"
echo "  ✓ System information collected"

# 2) Service & container status
echo ""
echo "[2/6] Collecting service and container status..."
{
    echo "=== systemctl status docker ==="
    systemctl status docker --no-pager 2>&1 || true
    echo ""

    echo "=== systemctl status npm ==="
    systemctl status npm --no-pager 2>&1 || true
    echo ""

    echo "=== systemctl status npm-init ==="
    systemctl status npm-init --no-pager 2>&1 || true
    echo ""

    echo "=== systemctl status amazon-cloudwatch-agent ==="
    systemctl status amazon-cloudwatch-agent --no-pager 2>&1 || true
    echo ""

    echo "=== docker ps ==="
    docker ps 2>&1 || true
    echo ""

    echo "=== docker compose ps (in /opt/npm) ==="
    if [[ -d /opt/npm ]]; then
        (cd /opt/npm && docker compose ps) 2>&1 || true
    else
        echo "  /opt/npm not found"
    fi
    echo ""

} > "${BUNDLE_DIR}/services-and-containers.txt"
echo "  ✓ Service and container status collected"

# 3) NPM admin credentials (optional)
echo ""
echo "[3/6] Collecting admin credential metadata..."

CREDS_FILE="/root/npm-admin-credentials.txt"
if [[ -f "$CREDS_FILE" ]]; then
    # Copy credentials file but DO NOT include in bundle by default
    # Instead, include a note explaining where it is.
    {
        echo "Credentials file exists at: $CREDS_FILE"
        echo "Content is NOT included in this bundle for security reasons."
        echo "If requested by support and you are comfortable, you can share it manually."
    } > "${BUNDLE_DIR}/credentials-info.txt"
    echo "  ✓ Recorded credentials file location (content not included)"
else
    echo "  ℹ Credentials file not found at $CREDS_FILE"
    echo "Credentials file not found at $CREDS_FILE" > "${BUNDLE_DIR}/credentials-info.txt"
fi

# 4) Logs
echo ""
echo "[4/6] Collecting log files..."

LOG_DIR="${BUNDLE_DIR}/logs"
mkdir -p "$LOG_DIR"

copy_log_if_exists() {
    local src="$1"
    local dest_name="$2"

    if [[ -f "$src" ]]; then
        cp "$src" "${LOG_DIR}/${dest_name}"
        echo "  ✓ Copied: $src -> ${dest_name}"
    else
        echo "  ℹ Missing log: $src"
    fi
}

# Core system logs
copy_log_if_exists "/var/log/syslog" "syslog"
copy_log_if_exists "/var/log/auth.log" "auth.log"
copy_log_if_exists "/var/log/cloud-init.log" "cloud-init.log"
copy_log_if_exists "/var/log/dpkg.log" "dpkg.log"

# NPM logs (if any)
if [[ -d /var/log/npm ]]; then
    tar -czf "${LOG_DIR}/npm-logs.tar.gz" -C /var/log npm 2>/dev/null || true
    echo "  ✓ Archived NPM logs directory (/var/log/npm)"
else
    echo "  ℹ /var/log/npm directory not found"
fi

# Journal snippet (last 1000 lines)
if command -v journalctl &>/dev/null; then
    journalctl -n 1000 > "${LOG_DIR}/journal-last-1000.log" 2>&1 || true
    echo "  ✓ Captured last 1000 journal lines"
fi

echo "  ✓ Log collection complete"

# 5) NPM data metadata (no actual data)
echo ""
echo "[5/6] Collecting NPM data metadata (no secrets)..."

{
    echo "=== ls -l /opt/npm ==="
    ls -l /opt/npm 2>&1 || true
    echo ""

    echo "=== ls -l /opt/npm/data ==="
    ls -l /opt/npm/data 2>&1 || true
    echo ""

    echo "=== ls -l /opt/npm/letsencrypt ==="
    ls -l /opt/npm/letsencrypt 2>&1 || true
    echo ""

    echo "=== du -sh /opt/npm/data /opt/npm/letsencrypt ==="
    du -sh /opt/npm/data /opt/npm/letsencrypt 2>/dev/null || true
    echo ""

} > "${BUNDLE_DIR}/npm-data-metadata.txt"
echo "  ✓ NPM data metadata collected"

# 6) Backup metadata
echo ""
echo "[6/6] Collecting backup metadata..."

{
    echo "=== /etc/npm-backup.conf ==="
    if [[ -f /etc/npm-backup.conf ]]; then
        sed 's/^/# /' /etc/npm-backup.conf || true
    else
        echo "# /etc/npm-backup.conf not found"
    fi
    echo ""

    echo "=== backup files in ${OUTPUT_BASE} ==="
    find "$OUTPUT_BASE" -maxdepth 1 -type f -name "npm-*.tar.gz" -printf "%f %TY-%Tm-%Td %TH:%TM\n" 2>/dev/null || true
    echo ""

} > "${BUNDLE_DIR}/backup-metadata.txt"
echo "  ✓ Backup metadata collected"

# Tar everything up
echo ""
echo "Creating archive: $BUNDLE_ARCHIVE"
tar -czf "$BUNDLE_ARCHIVE" -C "$OUTPUT_BASE" "npm-support-${TIMESTAMP}"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ Support bundle created: $BUNDLE_ARCHIVE"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "You can provide this file to support (after reviewing its contents):"
echo "  $BUNDLE_ARCHIVE"
echo ""

exit 0

