#!/usr/bin/env bash
# Start NPM docker compose stack with a post-start health check so systemd can retry on failure.

set -euo pipefail

COMPOSE_CMD="/usr/bin/docker compose"
STACK_DIR="/opt/npm"

cd "$STACK_DIR"

echo "Starting Nginx Proxy Manager stack..."
if ! ${COMPOSE_CMD} up -d; then
    echo "docker compose up failed"
    exit 1
fi

echo "Verifying containers are running..."
max_attempts=30
sleep_seconds=2
last_status_output=""

for ((attempt=1; attempt<=max_attempts; attempt++)); do
    # docker compose ps can briefly return nothing or fail while docker is still coming up
    status_output=$(${COMPOSE_CMD} ps --format '{{.Name}} {{.State}}' 2>/dev/null || true)
    last_status_output="$status_output"

    if [[ -n "$status_output" ]]; then
        failed=0
        while IFS= read -r line; do
            [[ -z "$line" ]] && continue
            state=${line#* }
            if [[ "$state" != running* && "$state" != healthy* ]]; then
                failed=1
                break
            fi
        done <<< "$status_output"

        if (( failed == 0 )); then
            echo "All NPM containers are running/healthy"
            exit 0
        fi
    fi

    if (( attempt < max_attempts )); then
        sleep "$sleep_seconds"
    fi
done

echo "Timed out waiting for NPM containers to become running/healthy"
if [[ -z "$last_status_output" ]]; then
    echo "No containers reported by docker compose"
else
    echo "Last reported container states:"
    while IFS= read -r line; do
        [[ -z "$line" ]] && continue
        name=${line%% *}
        state=${line#* }
        echo " - ${name}: ${state}"
    done <<< "$last_status_output"
fi

echo
echo "docker compose ps:"
${COMPOSE_CMD} ps || true
exit 1
