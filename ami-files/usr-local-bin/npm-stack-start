#!/usr/bin/env bash
# Start NPM docker compose stack with a post-start health check so systemd can retry on failure.

set -euo pipefail

COMPOSE_CMD="/usr/bin/docker compose"
STACK_DIR="/opt/npm"

cd "$STACK_DIR"

echo "Starting Nginx Proxy Manager stack..."
if ! ${COMPOSE_CMD} up -d; then
    echo "docker compose up failed"
    exit 1
fi

echo "Verifying containers are running..."
sleep 5

status_output=$(${COMPOSE_CMD} ps --format '{{.Name}} {{.State}}')
if [[ -z "$status_output" ]]; then
    echo "No containers reported by docker compose"
    exit 1
fi

failed=0
while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    name=${line%% *}
    state=${line#* }
    echo " - ${name}: ${state}"
    if [[ "$state" != running* ]]; then
        failed=1
    fi
done <<< "$status_output"

if (( failed )); then
    echo "One or more NPM containers are not running; failing for systemd retry"
    exit 1
fi

echo "NPM containers are running"
